# Javascript基础 - 页面渲染

## 目录
- [浏览器工作的流程](#浏览器工作的流程)
- [浏览器渲染页面的原理](#浏览器渲染页面的原理)
- [浏览器渲染Web页面大约会经过六个过程：](#浏览器渲染web页面大约会经过六个过程)
- [图片加载和渲染的时机](#图片加载和渲染的时机)
- [Web页面中不是所有的图片都会加载和渲染](#web页面中不是所有的图片都会加载和渲染)
- [async和defer的区别](#async和defer的区别)

### 浏览器工作的流程

1. 输入网址
2. DNS服务器通过域名查找对应的web服务器ip地址
3. 浏览器给web服务器发送一个HTTP请求(这里涉及到客户端与服务器的 tcp 三次握手与四次挥手)
4. 服务器接收到获取请求，处理请求，返回一个HTML响应
5. 浏览器开始显示HTML(文档并不是全部都解析后才绘制到屏幕上，而是从上至下开始解析html，遇到css 会开启线程下载css)
6. 在浏览器显示HTML时，它会注意到需要获取其他地址内容的标签。这时，浏览器会发送一个获取请求来重新获得这些文件
7. 这些文件就包括CSS/JS/图片等资源，这些资源的地址都要经历一个和HTML读取类似的过程

### 浏览器渲染页面的原理

1. 用户输入网址（假设是个html页面，并且是第一次访问），浏览器向服务器发出请求，服务器返回html文件
2. 然后浏览器从head标签开始逐行解析HTML代码，遇到link标签又会向服务器请求加载css文件，不过这个过程是异步的，有多个css文件，会多个同时加载。
3. 继续往后如果遇到script标签或者js文件就会立即执行它，而且js文件的加载是同步的。
4. 到了body标签就开始渲染页面了，按照从头到尾的顺序依次渲染dom元素，如果遇到img标签会异步向服务器发送请求加载图片文件，执行此过程时浏览器会继续渲染页面，因为加载图片文件是异步的。
5. 如果遇到了dom节点的变化，元素尺寸变化，浏览器不得不回头重新渲染这部分代码。
6. 不同于css文件，js是阻塞式的加载，当浏览器在执行js代码时，不会做其他的事情。只有js代码执行后，才会继续渲染页面。所以应该把js放到页面的底部。

### 浏览器渲染Web页面大约会经过六个过程：

1. 解析HTML，构建DOM树
2. 解析加载的样式，构建样式规则树
3. 加载JavaScript，执行JavaScript代码
4. DOM树和样式规则树进行匹配，构成渲染树
5. 计算元素位置，进行页面布局
6. 绘制页面，最终在浏览器中呈现

### 图片加载和渲染的时机

1. 解析HTML时，如果遇到img或picture标签，将会加载图片
2. 解析加载的样式，遇到background-image时，并不会加载图片，而会构建样式规则树
3. 加载JavaScript，执行JavaScript代码，如果代码中有创建img元素之类，会添加到DOM树中；如查有添加background-image规则，将会添加到样式规则树中
4. DOM树和样式规则匹配时构建渲染树，如果DOM树节点匹配到样式规则中的background-image，则会加载背景图片
5. 计算元素（图片）位置进行布局
6. 开始渲染图片，浏览器将呈现渲染出来的图片

### Web页面中不是所有的图片都会加载和渲染

1. img/picture标签和设置background-image的元素遇到display:none时，图片会加载但不会渲染
2. img/picture标签和设置background-image的元素祖先元素设置display:none时，background-image不会渲染也不会加载，而img/picture标签引入的图片会加载但不会渲染
3. img/picture标签和background-image引入相同路径相同图片文件名时，图片只会加载一次
4. 样式文件中background-image引入的图片，如果匹配不到DOM元素，图片不会加载
5. 伪类引入的background-image，比如:hover，只有当伪类被触发时，图片才会加载

### async和defer的区别

* async

1. 使用 async，不阻塞解析，并行下载脚本，当下载完成后，阻塞解析立即执行，在解析完成前后都可能被执行。
2. async 会在 load 事件之前执行，但并不能确保与 DOMContentLoaded 的执行先后顺序。
3. async 的脚本并不保证按照指定它们的先后顺序执行。

* defer

1. 使用 defer，并行下载，并在页面完成解析后，进行执行，不会阻塞解析。
2. defer 会在 DOMContentLoaded 事件触发之前执行。
3. defer 的脚本是按照加载顺序执行的。